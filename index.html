<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스퀘어건축사사무소 26년 연차 신청 시스템</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #f5f5f5; --bg-secondary: #ffffff; --bg-tertiary: #e8e8e8;
            --text-primary: #1a1a1a; --text-secondary: #666666;
            --accent-blue: #3b82f6; --accent-green: #10b981; --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6; --accent-red: #ef4444; --accent-pink: #ec4899;
            --accent-orange: #f97316; --border-color: #ddd;
        }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; padding: 30px 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 2.2rem; font-weight: 700; background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
        .subtitle { color: var(--text-secondary); font-size: 0.95rem; }
        .admin-info { display: inline-block; margin-top: 10px; padding: 6px 14px; background: var(--bg-tertiary); border-radius: 20px; font-size: 0.85rem; color: var(--text-secondary); }
        .admin-info strong { color: var(--accent-purple); }
        .header-actions { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .user-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .user-tab { padding: 12px 24px; border-radius: 12px; border: 2px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .user-tab:hover { border-color: var(--accent-blue); }
        .user-tab.active { border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.15); color: var(--text-primary); }
        .user-tab .user-dot { width: 10px; height: 10px; border-radius: 50%; }
        .user-tab .user-leave-info { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; background: var(--bg-tertiary); padding: 2px 8px; border-radius: 6px; }
        .user-tab .user-leave-info.unlimited { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .btn { padding: 10px 18px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; font-family: 'Noto Sans KR', sans-serif; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-success { background: var(--accent-green); color: white; }
        .btn-warning { background: var(--accent-orange); color: white; }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .btn svg { width: 16px; height: 16px; }
        .dashboard { display: grid; grid-template-columns: 1fr 380px; gap: 25px; }
        @media (max-width: 1200px) { .dashboard { grid-template-columns: 1fr; } }
        .panel { background: var(--bg-secondary); border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; }
        .panel-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .panel-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .panel-title svg { width: 18px; height: 18px; }
        .panel-body { padding: 20px; }
        .month-nav { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .month-nav-btn { background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); width: 40px; height: 40px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .month-nav-btn:hover { background: var(--accent-blue); border-color: var(--accent-blue); }
        .month-nav-title { font-size: 1.3rem; font-weight: 600; min-width: 150px; text-align: center; }
        .team-legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .team-legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .team-legend-dot { width: 12px; height: 12px; border-radius: 4px; }
        .calendar-single { background: var(--bg-tertiary); border-radius: 12px; padding: 20px; }
        .weekdays-row { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 10px; }
        .weekday-cell { text-align: center; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; padding: 10px; }
        .weekday-cell:first-child { color: var(--accent-red); }
        .weekday-cell:last-child { color: var(--accent-blue); }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-cell { min-height: 90px; background: var(--bg-secondary); border-radius: 8px; padding: 6px; cursor: pointer; transition: all 0.15s; display: flex; flex-direction: column; }
        .day-cell:hover:not(.empty):not(.weekend):not(.holiday) { background: var(--bg-primary); transform: translateY(-2px); }
        .day-cell.empty { background: transparent; cursor: default; }
        .day-cell.weekend, .day-cell.holiday { opacity: 0.4; cursor: not-allowed; }
        .day-cell.selected { border: 2px solid var(--accent-blue); background: rgba(59, 130, 246, 0.15); }
        .day-number { font-size: 0.85rem; font-weight: 500; margin-bottom: 4px; }
        .day-cell.sunday .day-number { color: var(--accent-red); }
        .day-cell.saturday .day-number { color: var(--accent-blue); }
        .day-leaves { display: flex; flex-direction: column; gap: 2px; flex: 1; overflow: hidden; }
        .day-leave-item { font-size: 0.65rem; padding: 3px 6px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; color: #1a1a1a; }
        .day-leave-item.user-0 { background: rgba(59, 130, 246, 0.3); border-left: 3px solid #3b82f6; }
        .day-leave-item.user-1 { background: rgba(16, 185, 129, 0.3); border-left: 3px solid #10b981; }
        .day-leave-item.user-2 { background: rgba(236, 72, 153, 0.3); border-left: 3px solid #ec4899; }
        .day-leave-item.user-3 { background: rgba(245, 158, 11, 0.3); border-left: 3px solid #f59e0b; }
        .day-leave-item.user-4 { background: rgba(139, 92, 246, 0.3); border-left: 3px solid #8b5cf6; }
        .day-leave-item.user-5 { background: rgba(6, 182, 212, 0.3); border-left: 3px solid #06b6d4; }
        .day-leave-item.user-6 { background: rgba(249, 115, 22, 0.3); border-left: 3px solid #f97316; }
        .day-leave-item.user-7 { background: rgba(34, 197, 94, 0.3); border-left: 3px solid #22c55e; }
        .day-leave-item.user-8 { background: rgba(168, 85, 247, 0.3); border-left: 3px solid #a855f7; }
        .day-leave-item.user-9 { background: rgba(244, 63, 94, 0.3); border-left: 3px solid #f43f5e; }
        .day-leave-item.user-10 { background: rgba(20, 184, 166, 0.3); border-left: 3px solid #14b8a6; }
        .day-leave-item.user-11 { background: rgba(99, 102, 241, 0.3); border-left: 3px solid #6366f1; }
        .day-leave-item.user-12 { background: rgba(234, 179, 8, 0.3); border-left: 3px solid #eab308; }
        .day-leave-item.user-13 { background: rgba(217, 70, 239, 0.3); border-left: 3px solid #d946ef; }
        .day-leave-item.user-14 { background: rgba(251, 146, 60, 0.3); border-left: 3px solid #fb923c; }
        .day-leave-item.pending { opacity: 0.6; border-style: dashed; }
        .day-leave-item.cancel-requested { background: rgba(239, 68, 68, 0.2); border-left: 3px solid var(--accent-red); }
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .status-badge.pending { background: rgba(249, 115, 22, 0.2); color: var(--accent-orange); }
        .status-badge.approved { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .status-badge.cancel-requested { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .leave-type-legend { display: flex; gap: 16px; justify-content: center; padding: 16px; background: var(--bg-tertiary); border-radius: 10px; flex-wrap: wrap; margin-top: 16px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary); }
        .legend-dot { width: 10px; height: 10px; border-radius: 3px; }
        .leave-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .leave-stats.unlimited-user { grid-template-columns: repeat(2, 1fr); }
        .stat-card { background: var(--bg-tertiary); border-radius: 10px; padding: 14px; text-align: center; }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; margin-bottom: 2px; }
        .stat-value.total { color: var(--accent-blue); }
        .stat-value.used { color: var(--accent-purple); }
        .stat-value.remaining { color: var(--accent-green); }
        .stat-value.pending { color: var(--accent-orange); }
        .stat-label { font-size: 0.7rem; color: var(--text-secondary); font-weight: 500; }
        .team-member { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 10px; margin-bottom: 8px; }
        .team-member-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
        .team-member-info { flex: 1; }
        .team-member-name { font-weight: 500; font-size: 0.9rem; margin-bottom: 2px; }
        .team-member-stats { font-size: 0.75rem; color: var(--text-secondary); }
        .team-member-bar { width: 60px; height: 6px; background: var(--bg-primary); border-radius: 3px; overflow: hidden; }
        .team-member-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .unlimited-badge { font-size: 0.7rem; padding: 2px 8px; background: rgba(16, 185, 129, 0.2); color: var(--accent-green); border-radius: 10px; }
        .selected-list { max-height: 350px; overflow-y: auto; }
        .selected-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 6px; }
        .selected-item.pending { border-left: 3px solid var(--accent-orange); }
        .selected-item.approved { border-left: 3px solid var(--accent-green); }
        .selected-item.cancel-requested { border-left: 3px solid var(--accent-red); }
        .selected-item-info { display: flex; align-items: center; gap: 10px; flex: 1; }
        .selected-item-dot { width: 8px; height: 8px; border-radius: 50%; }
        .selected-item-date { font-weight: 500; font-size: 0.85rem; }
        .selected-item-type { font-size: 0.75rem; color: var(--text-secondary); }
        .empty-state { text-align: center; padding: 30px; color: var(--text-secondary); }
        .empty-state svg { width: 40px; height: 40px; margin-bottom: 10px; opacity: 0.5; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-secondary); border-radius: 16px; border: 1px solid var(--border-color); width: 100%; max-width: 500px; transform: scale(0.9); transition: transform 0.2s; max-height: 90vh; overflow-y: auto; }
        .modal.large { max-width: 900px; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { padding: 18px 22px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.05rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px; display: flex; transition: color 0.2s; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 22px; }
        .modal-footer { padding: 14px 22px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; justify-content: flex-end; }
        .leave-options { display: flex; flex-direction: column; gap: 8px; }
        .leave-option { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--bg-tertiary); border: 2px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .leave-option:hover { border-color: var(--border-color); }
        .leave-option.selected { border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.1); }
        .leave-option-dot { width: 12px; height: 12px; border-radius: 50%; }
        .leave-option-dot.full { background: var(--accent-green); }
        .leave-option-dot.half { background: var(--accent-yellow); }
        .leave-option-dot.quarter { background: var(--accent-purple); }
        /* 시간 선택 영역 */
        .time-picker-area { display: none; margin-top: 12px; padding: 16px; background: var(--bg-tertiary); border-radius: 10px; border: 1px solid var(--border-color); }
        .time-picker-area.show { display: block; }
        .time-picker-row { display: flex; align-items: center; gap: 10px; }
        .time-picker-row label { font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; min-width: 50px; }
        .time-picker-row select { flex: 1; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.95rem; font-family: 'Noto Sans KR', sans-serif; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; }
        .time-picker-row select:focus { outline: none; border-color: var(--accent-blue); }
        .time-picker-row .time-sep { font-size: 1rem; color: var(--text-secondary); }
        .time-picker-info { margin-top: 10px; font-size: 0.8rem; color: var(--accent-blue); font-weight: 500; }
        .time-picker-hours { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-purple); }
        .time-preset-btns { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .time-preset-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); font-size: 0.78rem; font-weight: 500; cursor: pointer; transition: all 0.15s; font-family: 'Noto Sans KR', sans-serif; }
        .time-preset-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
        .time-preset-btn.active { border-color: var(--accent-blue); background: rgba(59,130,246,0.1); color: var(--accent-blue); }
        .leave-option-info { flex: 1; }
        .leave-option-name { font-weight: 500; font-size: 0.9rem; }
        .leave-option-desc { font-size: 0.75rem; color: var(--text-secondary); }
        .date-leaves-info { margin-bottom: 20px; padding: 14px; background: var(--bg-tertiary); border-radius: 10px; }
        .date-leaves-title { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px; }
        .date-leave-user { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 0.85rem; }
        .date-leave-user-dot { width: 8px; height: 8px; border-radius: 50%; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px; font-weight: 500; }
        .form-input, .form-textarea { width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 14px; color: var(--text-primary); font-size: 0.95rem; font-family: 'Noto Sans KR', sans-serif; transition: border-color 0.2s; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--accent-blue); }
        .form-checkbox { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .form-checkbox input { width: 18px; height: 18px; accent-color: var(--accent-blue); }
        .form-checkbox label { font-size: 0.85rem; color: var(--text-secondary); }
        .bonus-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 6px; border-left: 3px solid var(--accent-yellow); }
        .bonus-item-info { flex: 1; }
        .bonus-item-days { font-weight: 600; color: var(--accent-yellow); margin-right: 10px; }
        .bonus-item-reason { font-size: 0.85rem; color: var(--text-secondary); }
        .bonus-item-date { font-size: 0.75rem; color: var(--text-secondary); }
        .tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; flex-wrap: wrap; }
        .tab { padding: 8px 16px; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem; font-weight: 500; border-radius: 6px; transition: all 0.2s; }
        .tab:hover { background: var(--bg-tertiary); }
        .tab.active { background: var(--accent-blue); color: white; }
        .pending-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 10px; margin-bottom: 8px; border-left: 3px solid var(--accent-orange); }
        .pending-item-info { flex: 1; }
        .pending-item-user { font-weight: 600; margin-bottom: 4px; }
        .pending-item-date { font-size: 0.85rem; color: var(--text-secondary); }
        .pending-item-actions { display: flex; gap: 6px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        .report-table th, .report-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .report-table th { background: var(--bg-tertiary); font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); }
        .report-table td { font-size: 0.9rem; }
        .report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .report-summary-card { background: var(--bg-tertiary); padding: 16px; border-radius: 10px; text-align: center; }
        .report-summary-value { font-family: 'JetBrains Mono', monospace; font-size: 1.8rem; font-weight: 700; }
        .report-summary-label { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-tertiary); border: 1px solid var(--border-color); padding: 12px 20px; border-radius: 10px; font-size: 0.9rem; opacity: 0; transition: all 0.3s; z-index: 2000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { border-color: var(--accent-red); background: rgba(239, 68, 68, 0.15); }
        .toast.success { border-color: var(--accent-green); background: rgba(16, 185, 129, 0.15); }
        .notification-badge { background: var(--accent-red); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: 6px; }
        .sync-status { display: inline-flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; }
        .sync-dot.online { background: var(--accent-green); box-shadow: 0 0 6px rgba(16, 185, 129, 0.5); }
        .sync-dot.offline { background: var(--accent-red); box-shadow: 0 0 6px rgba(239, 68, 68, 0.5); }
        .sync-dot.syncing { background: var(--accent-yellow); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .sync-update-flash { animation: flashBg 1.5s ease; }
        @keyframes flashBg { 0% { background: rgba(59, 130, 246, 0.15); } 100% { background: transparent; } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
    </style>
</head>
<body>
    <div id="loadingOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:16px;">
        <div style="width:40px;height:40px;border:4px solid var(--border-color);border-top:4px solid var(--accent-blue);border-radius:50%;animation:spin 0.8s linear infinite;"></div>
        <div style="color:var(--text-secondary);font-size:0.95rem;">데이터를 불러오는 중...</div>
        <style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>
    </div>
    <div class="container">
        <header>
            <h1>스퀘어건축사사무소 26년 연차 신청 시스템</h1>
            
            <div class="admin-info">관리자: <strong>주유진</strong> (경영관리팀)</div>
            <div class="sync-status" id="syncStatus">
                <div class="sync-dot online" id="syncDot"></div>
                <span id="syncText">실시간 연결됨</span>
                <span id="lastSyncTime" style="margin-left:8px;font-size:0.75rem;color:var(--text-secondary)"></span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openReportModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    연차 리포트
                </button>
                <button class="btn btn-warning" onclick="openAdminModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    관리자
                    <span class="notification-badge" id="pendingBadge" style="display: none;">0</span>
                </button>
            </div>
        </header>
        <div class="user-tabs" id="userTabs"></div>
        <div style="text-align:center;margin-top:-10px;margin-bottom:20px;">
            <p class="subtitle" style="margin-bottom:12px">본인 이름을 선택하고 달력에서 날짜를 클릭하여 연차를 신청하세요</p>
            <div id="quickJoinArea" style="display:inline-flex;align-items:center;gap:8px;background:var(--bg-secondary);padding:10px 16px;border-radius:12px;border:1px solid var(--border-color);">
                <span style="font-size:0.85rem;color:var(--text-secondary);">처음이신가요?</span>
                <input type="text" id="quickJoinName" class="form-input" placeholder="이름 입력" style="width:140px;padding:8px 12px;font-size:0.9rem;">
                <button class="btn btn-primary btn-small" onclick="quickJoin()">참여하기</button>
            </div>
        </div>
        <div class="dashboard">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        팀 연차 달력
                    </div>
                </div>
                <div class="panel-body">
                    <div class="month-nav">
                        <button class="month-nav-btn" onclick="changeMonth(-1)"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                        <div class="month-nav-title" id="monthTitle">2026년 1월</div>
                        <button class="month-nav-btn" onclick="changeMonth(1)"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                    </div>
                    <div class="team-legend" id="teamLegend"></div>
                    <div class="calendar-single" id="calendar"></div>
                    <div class="leave-type-legend">
                        <div class="legend-item"><div class="legend-dot" style="background: var(--accent-green);"></div>연차 (1일)</div>
                        <div class="legend-item"><div class="legend-dot" style="background: var(--accent-yellow);"></div>반차 (0.5일)</div>
                        <div class="legend-item"><div class="legend-dot" style="background: var(--accent-purple);"></div>반반차 (0.25일)</div>
                        <div class="legend-item" style="margin-left: 20px;"><div class="legend-dot" style="background: var(--accent-orange); opacity: 0.6;"></div>승인대기</div>
                        <div class="legend-item"><div class="legend-dot" style="background: var(--accent-green);"></div>승인완료</div>
                    </div>
                </div>
            </div>
            <div class="sidebar">
                <div class="panel">
                    <div class="panel-header"><div class="panel-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg><span id="currentUserTitle">내 연차 현황</span></div></div>
                    <div class="panel-body"><div class="leave-stats" id="leaveStats"></div></div>
                </div>
                <div class="panel" style="margin-top: 16px;">
                    <div class="panel-header"><div class="panel-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>전체 팀원 현황</div></div>
                    <div class="panel-body"><div class="team-overview" id="teamOverview"></div></div>
                </div>
                <div class="panel" style="margin-top: 16px;">
                    <div class="panel-header"><div class="panel-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>내 신청 내역</div></div>
                    <div class="panel-body"><div class="selected-list" id="selectedList"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 연차 선택 모달 -->
    <div class="modal-overlay" id="leaveModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="leaveModalTitle">연차 선택</div>
                <button class="modal-close" onclick="closeLeaveModal()"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="modal-body">
                <div class="date-leaves-info" id="dateLeavesInfo"></div>
                <div class="leave-options">
                    <div class="leave-option" data-type="full" onclick="selectLeaveType('full')"><div class="leave-option-dot full"></div><div class="leave-option-info"><div class="leave-option-name">연차</div><div class="leave-option-desc">1일 차감 (종일)</div></div></div>
                    <div class="leave-option" data-type="half" onclick="selectLeaveType('half')"><div class="leave-option-dot half"></div><div class="leave-option-info"><div class="leave-option-name">반차</div><div class="leave-option-desc">0.5일 차감 (시간 선택)</div></div></div>
                    <div class="leave-option" data-type="quarter" onclick="selectLeaveType('quarter')"><div class="leave-option-dot quarter"></div><div class="leave-option-info"><div class="leave-option-name">반반차</div><div class="leave-option-desc">0.25일 차감 (시간 선택)</div></div></div>
                </div>
                <!-- 시간 선택 영역 (반차/반반차 선택 시 표시) -->
                <div class="time-picker-area" id="timePickerArea">
                    <div style="font-size:0.85rem;font-weight:600;color:var(--text-primary);margin-bottom:12px;">시간 선택</div>
                    <div class="time-preset-btns" id="timePresetBtns">
                        <button class="time-preset-btn" onclick="applyTimePreset('am')">오전반차 (08:30~13:00)</button>
                        <button class="time-preset-btn" onclick="applyTimePreset('pm')">오후반차 (13:00~17:30)</button>
                    </div>
                    <div class="time-picker-row" style="margin-top:12px;">
                        <label>시작</label>
                        <select id="leaveStartTime" onchange="onTimeChange()"></select>
                        <span class="time-sep">~</span>
                        <label>종료</label>
                        <select id="leaveEndTime" onchange="onTimeChange()"></select>
                    </div>
                    <div class="time-picker-info" id="timePickerInfo"></div>
                </div>
                <p style="margin-top: 16px; font-size: 0.8rem; color: var(--accent-orange);">※ 신청 후 관리자 승인이 필요합니다.</p>
                <p style="margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary);">※ 연차는 회계연도(1월~12월) 기준으로 지급되며, 퇴사 시 재산정될 수 있습니다.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLeaveModal()">닫기</button>
                <button class="btn btn-primary" onclick="confirmLeave()">신청</button>
            </div>
        </div>
    </div>

    <!-- 관리자 모달 -->
    <div class="modal-overlay" id="adminModal">
        <div class="modal large">
            <div class="modal-header">
                <div class="modal-title">관리자 설정 (주유진)</div>
                <button class="modal-close" onclick="closeAdminModal()"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="modal-body">
                <div id="adminLoginForm">
                    <div class="form-group"><label class="form-label">관리자 비밀번호</label><input type="password" class="form-input" id="adminPassword" placeholder="비밀번호를 입력하세요" onkeypress="if(event.key==='Enter')adminLogin()"></div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="adminLogin()">로그인</button>
                </div>
                <div id="adminContent" style="display: none;">
                    <div class="tabs">
                        <button class="tab active" onclick="switchAdminTab('pending')">승인 대기 / 취소 요청 <span id="pendingCount"></span></button>
                        <button class="tab" onclick="switchAdminTab('users')">팀원 관리</button>
                        <button class="tab" onclick="switchAdminTab('leaves')">연차 관리</button>
                        <button class="tab" onclick="switchAdminTab('history')">취소 이력</button>
                        <button class="tab" onclick="switchAdminTab('settings')">설정</button>
                    </div>
                    <div id="adminTabPending" class="admin-tab-content"><div class="pending-list" id="pendingList"></div><div id="cancelRequestList" style="margin-top:16px"></div></div>
                    <div id="adminTabUsers" class="admin-tab-content" style="display: none;">
                        <div class="user-manage-list" id="userManageList"></div>
                        <h4 style="margin: 20px 0 12px; font-size: 0.9rem;">팀원 추가</h4>
                        <div class="form-group"><input type="text" class="form-input" id="newUserName" placeholder="이름 입력"></div>
                        <div class="form-group"><input type="number" class="form-input" id="newUserLeave" placeholder="기본 연차" value="15"></div>
                        <div class="form-checkbox"><input type="checkbox" id="newUserUnlimited"><label for="newUserUnlimited">무제한 연차</label></div>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="addUser()">팀원 추가</button>
                    </div>
                    <div id="adminTabLeaves" class="admin-tab-content" style="display: none;"><div id="leaveManageList"></div></div>
                    <div id="adminTabSettings" class="admin-tab-content" style="display: none;">
                        <div class="form-group"><label class="form-label">새 비밀번호</label><input type="password" class="form-input" id="newPassword" placeholder="새 비밀번호"></div>
                        <button class="btn btn-secondary" style="width: 100%;" onclick="changePassword()">비밀번호 변경</button>
                    </div>
                    <div id="adminTabHistory" class="admin-tab-content" style="display: none;"><div id="cancelHistoryList"></div></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeAdminModal()">닫기</button></div>
        </div>
    </div>

    <!-- 연차 수정 모달 -->
    <div class="modal-overlay" id="editLeaveModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="editLeaveTitle">연차 수정</div>
                <button class="modal-close" onclick="closeEditLeaveModal()"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">기본 연차 개수</label><input type="number" class="form-input" id="editLeaveValue" min="0" step="0.5"></div>
                <h4 style="margin: 20px 0 12px; font-size: 0.9rem;">포상 연차 추가</h4>
                <div class="form-group"><label class="form-label">포상 일수</label><input type="number" class="form-input" id="newBonusDays" min="0" step="0.5" value="0"></div>
                <div class="form-group"><label class="form-label">포상 사유</label><textarea class="form-textarea" id="newBonusReason" placeholder="포상 사유를 입력하세요"></textarea></div>
                <button class="btn btn-success btn-small" onclick="addBonusLeave()">포상 연차 추가</button>
                <div id="bonusList"></div>
                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-top: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-secondary); font-size: 0.85rem;">총 연차 (기본 + 포상)</span>
                        <span id="editTotalDisplay" style="font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 600; color: var(--accent-blue);">15일</span>
                    </div>
                </div>
                <div class="form-checkbox"><input type="checkbox" id="editUnlimited"><label for="editUnlimited">무제한 연차</label></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditLeaveModal()">취소</button>
                <button class="btn btn-primary" onclick="saveUserLeave()">저장</button>
            </div>
        </div>
    </div>

    <!-- 취소 요청 모달 -->
    <div class="modal-overlay" id="cancelRequestModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">연차 취소 요청</div>
                <button class="modal-close" onclick="closeCancelRequestModal()"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="modal-body">
                <p id="cancelRequestInfo" style="margin-bottom:16px;font-size:0.95rem"></p>
                <div class="form-group">
                    <label class="form-label">취소 사유</label>
                    <textarea class="form-textarea" id="cancelReason" placeholder="취소 사유를 입력하세요"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCancelRequestModal()">닫기</button>
                <button class="btn btn-danger" onclick="submitCancelRequest()">취소 요청</button>
            </div>
        </div>
    </div>

    <!-- 연차 리포트 모달 -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal large">
            <div class="modal-header">
                <div class="modal-title">스퀘어건축사사무소 26년 연차 리포트</div>
                <button class="modal-close" onclick="closeReportModal()"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="modal-body">
                <div class="report-summary" id="reportSummary"></div>
                <h4 style="margin-bottom: 12px; font-size: 0.9rem;">팀원별 연차 현황</h4>
                <table class="report-table">
                    <thead><tr><th>이름</th><th>기본</th><th>포상</th><th>총</th><th>사용</th><th>잔여</th><th>대기</th></tr></thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
                <h4 style="margin: 30px 0 12px; font-size: 0.9rem;">상세 사용 내역</h4>
                <div id="reportDetails"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReportModal()">닫기</button>
                <button class="btn btn-primary" onclick="exportReport()">내보내기</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Firebase 초기화
        const FB_CONFIG={apiKey:"AIzaSyCzngaCcenhH1tmZ7syugpI3H1wYBVhiJQ",authDomain:"test-168a4.firebaseapp.com",databaseURL:"https://test-168a4-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"test-168a4",storageBucket:"test-168a4.firebasestorage.app",messagingSenderId:"955362696992",appId:"1:955362696992:web:234b098db17412be27c145"};
        const fbApp=firebase.initializeApp(FB_CONFIG);
        const fbDb=firebase.database();
        const DB_ROOT = '/sq_vc_shared'; // Firebase 공유 데이터 경로

        const userColors = ['#3b82f6', '#10b981', '#ec4899', '#f59e0b', '#8b5cf6', '#06b6d4', '#f97316', '#22c55e', '#a855f7', '#f43f5e', '#14b8a6', '#6366f1', '#eab308', '#d946ef', '#fb923c'];
        const defaultState = {
            users: [
                { id: 1, name: '김영성', totalLeave: 15, bonusLeaves: [], unlimited: false, leaves: {} },
                { id: 2, name: '신수진', totalLeave: 15, bonusLeaves: [], unlimited: false, leaves: {} }
            ],
            adminPassword: 'ice080303', cancelHistory: []
        };
        // 공유 데이터 (Firebase에 저장) - users, adminPassword, cancelHistory
        let state = {
            users: [], currentUserId: 1, currentMonth: new Date().getMonth(),
            adminPassword: 'ice080303', selectedDates: [], selectedType: null,
            editingUserId: null, cancelHistory: [], cancelRequestDate: null
        };
        let isDragging = false, dragStartDate = null;
        let isSaving = false; // 저장 중 플래그 (실시간 리스너 무한루프 방지)
        const holidays2026 = {'2026-01-01':'신정','2026-02-16':'설날연휴','2026-02-17':'설날','2026-02-18':'설날연휴','2026-03-01':'삼일절','2026-05-05':'어린이날','2026-05-24':'부처님오신날','2026-06-06':'현충일','2026-08-15':'광복절','2026-09-24':'추석연휴','2026-09-25':'추석','2026-09-26':'추석연휴','2026-10-03':'개천절','2026-10-09':'한글날','2026-12-25':'크리스마스'};
        const leaveDeduction = { full: 1, half: 0.5, 'half-am': 0.5, 'half-pm': 0.5, quarter: 0.25 };
        const leaveLabels = { full: '연차', half: '반차', 'half-am': '오전반차', 'half-pm': '오후반차', quarter: '반반차' };

        // 시간 선택 관련
        function buildTimeOptions(selectId, defaultVal) {
            const sel = document.getElementById(selectId);
            sel.innerHTML = '';
            // 08:30 ~ 18:00 (30분 단위)
            for (let h = 8; h <= 18; h++) {
                for (let m = (h === 8 ? 30 : 0); m < 60; m += 30) {
                    if (h === 18 && m > 0) break;
                    const val = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
                    const opt = document.createElement('option');
                    opt.value = val; opt.textContent = val;
                    if (val === defaultVal) opt.selected = true;
                    sel.appendChild(opt);
                }
            }
        }
        function showTimePicker(type) {
            const area = document.getElementById('timePickerArea');
            const presetBtns = document.getElementById('timePresetBtns');
            if (type === 'half' || type === 'quarter') {
                area.classList.add('show');
                // 반차: 오전/오후 프리셋, 반반차: 2시간 프리셋 (출근 08:30 기준)
                if (type === 'quarter') {
                    presetBtns.innerHTML = `
                        <button class="time-preset-btn" onclick="applyTimePreset('q-am1')">오전 (08:30~10:30)</button>
                        <button class="time-preset-btn" onclick="applyTimePreset('q-am2')">점심전 (10:30~12:30)</button>
                        <button class="time-preset-btn" onclick="applyTimePreset('q-pm1')">오후 (13:30~15:30)</button>
                        <button class="time-preset-btn" onclick="applyTimePreset('q-pm2')">저녁전 (15:30~17:30)</button>`;
                    buildTimeOptions('leaveStartTime', '08:30');
                    buildTimeOptions('leaveEndTime', '10:30');
                } else {
                    presetBtns.innerHTML = `
                        <button class="time-preset-btn" onclick="applyTimePreset('am')">오전반차 (08:30~13:00)</button>
                        <button class="time-preset-btn" onclick="applyTimePreset('pm')">오후반차 (13:00~17:30)</button>`;
                    buildTimeOptions('leaveStartTime', '08:30');
                    buildTimeOptions('leaveEndTime', '13:00');
                }
                onTimeChange();
            } else {
                area.classList.remove('show');
            }
        }
        function applyTimePreset(preset) {
            const presets = {
                'am': ['08:30', '13:00'], 'pm': ['13:00', '17:30'],
                'q-am1': ['08:30', '10:30'], 'q-am2': ['10:30', '12:30'],
                'q-pm1': ['13:30', '15:30'], 'q-pm2': ['15:30', '17:30']
            };
            const [s, e] = presets[preset] || ['08:30', '13:00'];
            document.getElementById('leaveStartTime').value = s;
            document.getElementById('leaveEndTime').value = e;
            // 프리셋 버튼 활성화
            document.querySelectorAll('.time-preset-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            onTimeChange();
        }
        function onTimeChange() {
            const s = document.getElementById('leaveStartTime').value;
            const e = document.getElementById('leaveEndTime').value;
            const info = document.getElementById('timePickerInfo');
            if (s && e) {
                const sh = parseInt(s), sm = parseInt(s.substring(3));
                const eh = parseInt(e), em = parseInt(e.substring(3));
                const diffMin = (eh * 60 + em) - (sh * 60 + sm);
                const diffH = (diffMin / 60).toFixed(1);
                if (diffMin <= 0) {
                    info.innerHTML = '<span style="color:var(--accent-red);">종료시간은 시작시간보다 이후여야 합니다</span>';
                } else {
                    const ampm = sh < 12 ? '오전' : '오후';
                    info.innerHTML = `${s} ~ ${e} (<span class="time-picker-hours">${diffH}시간</span>)`;
                }
            }
            // 프리셋 활성화 체크
            document.querySelectorAll('.time-preset-btn').forEach(b => b.classList.remove('active'));
        }
        const months = ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
        const weekdays = ['일','월','화','수','목','금','토'];

        // ===== Firebase 실시간 저장/로드 =====
        let lastSyncTimestamp = null;

        function updateSyncStatus(status, text) {
            const dot = document.getElementById('syncDot');
            const txt = document.getElementById('syncText');
            if (!dot || !txt) return;
            dot.className = 'sync-dot ' + status;
            txt.textContent = text;
        }
        function updateLastSyncTime() {
            const el = document.getElementById('lastSyncTime');
            if (!el || !lastSyncTimestamp) return;
            const now = new Date(), diff = Math.floor((now - lastSyncTimestamp) / 1000);
            if (diff < 5) el.textContent = '(방금 동기화됨)';
            else if (diff < 60) el.textContent = `(${diff}초 전 동기화)`;
            else if (diff < 3600) el.textContent = `(${Math.floor(diff/60)}분 전 동기화)`;
            else el.textContent = `(${lastSyncTimestamp.toLocaleTimeString('ko-KR')} 동기화)`;
        }
        setInterval(updateLastSyncTime, 10000);

        function saveState() {
            isSaving = true;
            updateSyncStatus('syncing', '저장 중...');
            // 공유 데이터만 Firebase에 저장
            const sharedData = {
                users: state.users,
                adminPassword: state.adminPassword,
                cancelHistory: state.cancelHistory || [],
                lastUpdated: new Date().toISOString()
            };
            fbDb.ref(DB_ROOT).set(sharedData).then(() => {
                lastSyncTimestamp = new Date();
                updateSyncStatus('online', '실시간 연결됨');
                updateLastSyncTime();
                setTimeout(() => { isSaving = false; }, 500);
            }).catch(e => {
                console.error('Firebase save error:', e);
                isSaving = false;
                updateSyncStatus('offline', '저장 실패');
                showToast('데이터 저장 실패. 다시 시도해주세요.', 'error');
            });
            // 개인 설정은 localStorage에 (현재 선택된 사용자 기억)
            localStorage.setItem('sq_vc_local', JSON.stringify({
                currentUserId: state.currentUserId
            }));
        }

        function loadState() {
            return new Promise((resolve) => {
                fbDb.ref(DB_ROOT).once('value').then(snapshot => {
                    const data = snapshot.val();
                    if (data && data.users && data.users.length > 0) {
                        state.users = data.users;
                        state.adminPassword = data.adminPassword || 'ice080303';
                        state.cancelHistory = data.cancelHistory || [];
                        // users 데이터 정규화
                        state.users.forEach(u => {
                            if (!u.bonusLeaves) u.bonusLeaves = [];
                            if (!u.leaves) u.leaves = {};
                            Object.keys(u.leaves).forEach(d => {
                                if (typeof u.leaves[d] === 'string') u.leaves[d] = { type: u.leaves[d], status: 'approved' };
                            });
                        });
                    } else {
                        // Firebase에 데이터 없음 → 기존 localStorage에서 마이그레이션 시도
                        const oldSaved = localStorage.getItem('leaveSystem4');
                        if (oldSaved) {
                            const oldState = JSON.parse(oldSaved);
                            state.users = (oldState.users || defaultState.users).filter(u => u.id !== 0);
                            state.adminPassword = oldState.adminPassword || 'ice080303';
                            state.cancelHistory = oldState.cancelHistory || [];
                            state.users.forEach(u => {
                                if (!u.bonusLeaves) u.bonusLeaves = [];
                                if (!u.leaves) u.leaves = {};
                                Object.keys(u.leaves).forEach(d => {
                                    if (typeof u.leaves[d] === 'string') u.leaves[d] = { type: u.leaves[d], status: 'approved' };
                                });
                            });
                            // Firebase에 마이그레이션 저장
                            saveState();
                            showToast('기존 데이터를 공유 서버로 이전했습니다.', 'success');
                        } else {
                            // 완전 초기 상태
                            state.users = JSON.parse(JSON.stringify(defaultState.users));
                            state.adminPassword = defaultState.adminPassword;
                            state.cancelHistory = [];
                            saveState();
                        }
                    }
                    // 개인 설정 로드
                    const local = localStorage.getItem('sq_vc_local');
                    if (local) {
                        const localData = JSON.parse(local);
                        if (localData.currentUserId && state.users.find(u => u.id === localData.currentUserId)) {
                            state.currentUserId = localData.currentUserId;
                        } else if (state.users.length > 0) {
                            state.currentUserId = state.users[0].id;
                        }
                    } else if (state.users.length > 0) {
                        state.currentUserId = state.users[0].id;
                    }
                    state.currentMonth = new Date().getMonth();
                    lastSyncTimestamp = new Date();
                    updateSyncStatus('online', '실시간 연결됨');
                    updateLastSyncTime();
                    resolve();
                }).catch(e => {
                    console.error('Firebase load error:', e);
                    updateSyncStatus('offline', '오프라인 모드');
                    // 오프라인 폴백: localStorage 사용
                    const oldSaved = localStorage.getItem('leaveSystem4');
                    if (oldSaved) {
                        const oldState = JSON.parse(oldSaved);
                        state.users = oldState.users || defaultState.users;
                        state.adminPassword = oldState.adminPassword || 'ice080303';
                        state.cancelHistory = oldState.cancelHistory || [];
                    } else {
                        state.users = JSON.parse(JSON.stringify(defaultState.users));
                        state.adminPassword = defaultState.adminPassword;
                        state.cancelHistory = [];
                    }
                    state.currentMonth = new Date().getMonth();
                    if (state.users.length > 0) state.currentUserId = state.users[0].id;
                    showToast('오프라인 모드로 작동합니다.', 'error');
                    resolve();
                });
            });
        }

        // ===== Firebase 실시간 리스너 (다른 사용자 변경 감지) =====
        function startRealtimeSync() {
            fbDb.ref(DB_ROOT).on('value', snapshot => {
                if (isSaving) return; // 내가 저장한 것이면 무시
                const data = snapshot.val();
                if (!data || !data.users) return;

                // 변경 사항 감지 (다른 사용자의 변경 알림용)
                const prevUserCount = state.users.length;
                const prevLeaveCount = state.users.reduce((s, u) => s + Object.keys(u.leaves || {}).length, 0);

                // 공유 데이터 업데이트
                state.users = data.users;
                state.adminPassword = data.adminPassword || 'ice080303';
                state.cancelHistory = data.cancelHistory || [];
                // users 데이터 정규화
                state.users.forEach(u => {
                    if (!u.bonusLeaves) u.bonusLeaves = [];
                    if (!u.leaves) u.leaves = {};
                });
                // 현재 선택된 사용자가 삭제된 경우 처리
                if (!state.users.find(u => u.id === state.currentUserId) && state.users.length > 0) {
                    state.currentUserId = state.users[0].id;
                }

                // 변경 감지 알림
                const newUserCount = state.users.length;
                const newLeaveCount = state.users.reduce((s, u) => s + Object.keys(u.leaves || {}).length, 0);
                if (prevUserCount > 0 && (prevUserCount !== newUserCount || prevLeaveCount !== newLeaveCount)) {
                    showToast('다른 사용자가 데이터를 업데이트했습니다. 화면이 갱신됩니다.', 'success');
                    // 화면 깜빡임 효과로 갱신 알림
                    document.querySelector('.container').classList.add('sync-update-flash');
                    setTimeout(() => document.querySelector('.container').classList.remove('sync-update-flash'), 1500);
                }

                lastSyncTimestamp = new Date();
                updateSyncStatus('online', '실시간 연결됨');
                updateLastSyncTime();
                updateUI();
            });

            // Firebase 연결 상태 모니터링
            fbDb.ref('.info/connected').on('value', snap => {
                if (snap.val() === true) {
                    updateSyncStatus('online', '실시간 연결됨');
                } else {
                    updateSyncStatus('offline', '연결 끊김 - 재연결 시도 중');
                }
            });
        }
        function getCurrentUser() { return state.users.find(u => u.id === state.currentUserId); }
        function getTotalBonus(user) { return (user.bonusLeaves || []).reduce((s, b) => s + b.days, 0); }
        function getTotalLeave(user) { return user.totalLeave + getTotalBonus(user); }
        function calculateUsed(user) { return Object.values(user.leaves).reduce((s, l) => (l.status === 'approved' || l.status === 'cancel-requested') ? s + leaveDeduction[l.type] : s, 0); }
        function calculatePending(user) { return Object.values(user.leaves).reduce((s, l) => l.status === 'pending' ? s + leaveDeduction[l.type] : s, 0); }
        function getPendingCount(user) { return Object.values(user.leaves).filter(l => l.status === 'pending').length; }
        function getTotalPendingCount() { return state.users.reduce((s, u) => s + getPendingCount(u), 0); }
        function getCancelRequestCount() { let c = 0; state.users.forEach(u => { c += Object.values(u.leaves).filter(l => l.status === 'cancel-requested').length; }); return c; }

        function renderUserTabs() {
            const c = document.getElementById('userTabs');
            c.innerHTML = state.users.map(u => {
                const used = calculateUsed(u), color = userColors[u.id % userColors.length];
                let info = u.unlimited ? '' : `<span class="user-leave-info">${getTotalLeave(u) - used}/${getTotalLeave(u)}</span>`;
                return `<div class="user-tab ${u.id === state.currentUserId ? 'active' : ''}" onclick="selectUser(${u.id})"><div class="user-dot" style="background:${color}"></div><span>${u.name}</span>${info}</div>`;
            }).join('');
            const pc = getTotalPendingCount() + getCancelRequestCount(), badge = document.getElementById('pendingBadge');
            badge.textContent = pc; badge.style.display = pc > 0 ? 'inline' : 'none';
        }

        function renderTeamLegend() {
            document.getElementById('teamLegend').innerHTML = state.users.map(u => `<div class="team-legend-item"><div class="team-legend-dot" style="background:${userColors[u.id % userColors.length]}"></div><span>${u.name}</span></div>`).join('');
        }

        function selectUser(id) { state.currentUserId = id; localStorage.setItem('sq_vc_local', JSON.stringify({currentUserId: id})); updateUI(); }
        function changeMonth(d) { state.currentMonth += d; if (state.currentMonth < 0) state.currentMonth = 11; if (state.currentMonth > 11) state.currentMonth = 0; renderCalendar(); }

        function renderCalendar() {
            const m = state.currentMonth;
            document.getElementById('monthTitle').textContent = `2026년 ${months[m]}`;
            let html = '<div class="weekdays-row">' + weekdays.map(d => `<div class="weekday-cell">${d}</div>`).join('') + '</div><div class="days-grid">';
            const fd = new Date(2026, m, 1).getDay(), dim = new Date(2026, m + 1, 0).getDate();
            for (let i = 0; i < fd; i++) html += '<div class="day-cell empty"></div>';
            for (let d = 1; d <= dim; d++) {
                const date = new Date(2026, m, d), dow = date.getDay(), ds = `2026-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let cls = ['day-cell']; if (dow === 0) cls.push('sunday','weekend'); if (dow === 6) cls.push('saturday','weekend'); if (holidays2026[ds]) cls.push('holiday');
                if (state.selectedDates && state.selectedDates.includes(ds)) cls.push('selected');
                const isClickable = dow !== 0 && dow !== 6 && !holidays2026[ds], leaves = getLeavesForDate(ds);
                html += `<div class="${cls.join(' ')}" data-date="${ds}" ${isClickable ? `onmousedown="startDrag('${ds}')" onmouseenter="onDrag('${ds}')" onmouseup="endDrag()"` : ''}><div class="day-number">${d}</div><div class="day-leaves">`;
                leaves.forEach(l => { let statusCls = l.status === 'cancel-requested' ? 'cancel-requested' : l.status; const timeStr = (l.start_time && l.end_time) ? ' '+l.start_time.substring(0,5)+'~'+l.end_time.substring(0,5) : ''; html += `<div class="day-leave-item user-${l.userId % 15} ${statusCls}">${l.userName} ${leaveLabels[l.type] || leaveLabels['half']}${timeStr}</div>`; });
                html += '</div></div>';
            }
            document.getElementById('calendar').innerHTML = html + '</div>';
        }

        function isValidDate(ds) { const d = new Date(ds), dow = d.getDay(); return dow !== 0 && dow !== 6 && !holidays2026[ds]; }
        function startDrag(ds) { const u = getCurrentUser(); if (u.leaves[ds]) return; isDragging = true; dragStartDate = ds; state.selectedDates = [ds]; renderCalendar(); }
        function onDrag(ds) { if (!isDragging || !isValidDate(ds)) return; const u = getCurrentUser(); if (u.leaves[ds]) return; const all = getDateRange(dragStartDate, ds); state.selectedDates = all.filter(d => isValidDate(d) && !u.leaves[d]); renderCalendar(); }
        function endDrag() { if (isDragging && state.selectedDates.length > 0) { isDragging = false; openLeaveModal(); } isDragging = false; }
        function getDateRange(a, b) { const r = []; let s = new Date(a), e = new Date(b); if (s > e) { let t = s; s = e; e = t; } while (s <= e) { r.push(s.toISOString().split('T')[0]); s.setDate(s.getDate() + 1); } return r; }
        document.addEventListener('mouseup', () => { if (isDragging) endDrag(); });

        function getUserColorIndex(uid) { return state.users.findIndex(u => u.id === uid); }
        function getLeavesForDate(ds) {
            const r = [];
            state.users.forEach((u, idx) => { if (u.leaves[ds]) { const l = u.leaves[ds]; r.push({ userId: u.id, userIndex: idx, userName: u.name, type: l.type, status: l.status, start_time: l.start_time || '', end_time: l.end_time || '', hours: l.hours || 0 }); } });
            return r;
        }

        function updateStats() {
            const u = getCurrentUser(), used = calculateUsed(u), pend = getPendingCount(u);
            document.getElementById('currentUserTitle').textContent = `${u.name} 연차 현황`;
            const c = document.getElementById('leaveStats');
            if (u.unlimited) {
                c.className = 'leave-stats unlimited-user';
                c.innerHTML = `<div class="stat-card"><div class="stat-value used">${used}</div><div class="stat-label">승인 사용</div></div><div class="stat-card"><div class="stat-value pending">${pend}</div><div class="stat-label">승인 대기</div></div>`;
            } else {
                const t = getTotalLeave(u), r = t - used - calculatePending(u), bt = getTotalBonus(u);
                c.className = 'leave-stats';
                c.innerHTML = `<div class="stat-card"><div class="stat-value total">${t}${bt > 0 ? '<span style="font-size:0.7rem;color:var(--accent-yellow)">(+'+bt+')</span>' : ''}</div><div class="stat-label">총 연차</div></div><div class="stat-card"><div class="stat-value used">${used}</div><div class="stat-label">승인 사용</div></div><div class="stat-card"><div class="stat-value remaining">${r}</div><div class="stat-label">잔여</div></div><div class="stat-card"><div class="stat-value pending">${pend}</div><div class="stat-label">승인 대기</div></div>`;
            }
        }

        function renderTeamOverview() {
            document.getElementById('teamOverview').innerHTML = state.users.map(u => {
                const used = calculateUsed(u), color = userColors[u.id % userColors.length], bt = getTotalBonus(u);
                if (u.unlimited) return `<div class="team-member"><div class="team-member-dot" style="background:${color}"></div><div class="team-member-info"><div class="team-member-name">${u.name}</div><div class="team-member-stats">사용 ${used}일</div></div></div>`;
                const t = getTotalLeave(u), r = t - used, pct = t > 0 ? (used / t) * 100 : 0;
                return `<div class="team-member"><div class="team-member-dot" style="background:${color}"></div><div class="team-member-info"><div class="team-member-name">${u.name}${bt > 0 ? '<span style="color:var(--accent-yellow);font-size:0.7rem;margin-left:6px">포상+'+bt+'</span>' : ''}</div><div class="team-member-stats">사용 ${used}일 / 잔여 ${r}일</div></div><div class="team-member-bar"><div class="team-member-bar-fill" style="width:${pct}%;background:${color}"></div></div></div>`;
            }).join('');
        }

        function renderSelectedList() {
            const c = document.getElementById('selectedList'), u = getCurrentUser(), sorted = Object.entries(u.leaves).sort((a, b) => a[0].localeCompare(b[0]));
            if (sorted.length === 0) { c.innerHTML = '<div class="empty-state"><p>신청된 연차가 없습니다</p></div>'; return; }
            c.innerHTML = sorted.map(([ds, l]) => {
                const [y, m, d] = ds.split('-'), date = new Date(2026, parseInt(m)-1, parseInt(d)), wd = weekdays[date.getDay()];
                const dc = l.type === 'full' ? 'var(--accent-green)' : (l.type === 'half' || l.type === 'half-am' || l.type === 'half-pm') ? 'var(--accent-yellow)' : 'var(--accent-purple)';
                let badge = '', actionBtn = '', itemCls = l.status;
                if (l.status === 'pending') {
                    badge = '<span class="status-badge pending">승인대기</span>';
                    actionBtn = `<button class="btn btn-danger btn-small" onclick="cancelMyLeave('${ds}')">취소</button>`;
                } else if (l.status === 'cancel-requested') {
                    badge = '<span class="status-badge cancel-requested">취소요청중</span>';
                } else {
                    badge = '<span class="status-badge approved">승인완료</span>';
                    actionBtn = `<button class="btn btn-secondary btn-small" onclick="openCancelRequestModal('${ds}')">취소요청</button>`;
                }
                const timeStr = (l.start_time && l.end_time) ? ` (${l.start_time.substring(0,5)}~${l.end_time.substring(0,5)})` : '';
                return `<div class="selected-item ${itemCls}"><div class="selected-item-info"><div class="selected-item-dot" style="background:${dc}"></div><div><div class="selected-item-date">${parseInt(m)}월 ${parseInt(d)}일 (${wd}) ${badge}</div><div class="selected-item-type">${leaveLabels[l.type] || '반차'} - ${leaveDeduction[l.type] || 0.5}일${timeStr}</div></div></div><div>${actionBtn}</div></div>`;
            }).join('');
        }

        function cancelMyLeave(ds) {
            const u = getCurrentUser();
            if (u.leaves[ds] && u.leaves[ds].status === 'pending') {
                if (confirm('해당 연차 신청을 취소하시겠습니까?')) {
                    delete u.leaves[ds];
                    saveState();
                    updateUI();
                    showToast('연차 신청이 취소되었습니다.', 'success');
                }
            } else {
                showToast('승인 완료된 연차는 관리자에게 문의하세요.', 'error');
            }
        }

        function openCancelRequestModal(ds) {
            state.cancelRequestDate = ds;
            const u = getCurrentUser(), [y, m, d] = ds.split('-');
            document.getElementById('cancelRequestInfo').textContent = `${parseInt(m)}월 ${parseInt(d)}일 ${leaveLabels[u.leaves[ds].type]} 취소를 요청합니다.`;
            document.getElementById('cancelReason').value = '';
            document.getElementById('cancelRequestModal').classList.add('active');
        }
        function closeCancelRequestModal() { document.getElementById('cancelRequestModal').classList.remove('active'); state.cancelRequestDate = null; }
        function submitCancelRequest() {
            const reason = document.getElementById('cancelReason').value.trim();
            if (!reason) { showToast('취소 사유를 입력해주세요.', 'error'); return; }
            const u = getCurrentUser(), ds = state.cancelRequestDate;
            if (u.leaves[ds]) {
                u.leaves[ds].status = 'cancel-requested';
                u.leaves[ds].cancelReason = reason;
                u.leaves[ds].cancelRequestDate = new Date().toISOString();
                saveState(); updateUI(); closeCancelRequestModal();
                showToast('취소 요청이 접수되었습니다.', 'success');
            }
        }

        function openLeaveModal(ds) {
            const u = getCurrentUser();
            if (ds) {
                if (u.leaves[ds]) { showToast('이미 신청된 연차입니다.', 'error'); return; }
                state.selectedDates = [ds];
            }
            if (!state.selectedDates || state.selectedDates.length === 0) return;
            state.selectedType = null;
            const firstDs = state.selectedDates[0], [y, m, d] = firstDs.split('-');
            if (state.selectedDates.length > 1) {
                document.getElementById('leaveModalTitle').textContent = `${u.name} - ${state.selectedDates.length}일 연속 연차 신청`;
                document.getElementById('dateLeavesInfo').innerHTML = `<div class="date-leaves-title">선택된 날짜</div><div style="font-size:0.85rem">${state.selectedDates.map(dd => { const p = dd.split('-'); return `${parseInt(p[1])}/${parseInt(p[2])}`; }).join(', ')}</div>`;
                document.getElementById('dateLeavesInfo').style.display = 'block';
            } else {
                document.getElementById('leaveModalTitle').textContent = `${u.name} - ${parseInt(m)}월 ${parseInt(d)}일`;
                const leaves = getLeavesForDate(firstDs), ic = document.getElementById('dateLeavesInfo');
                if (leaves.length > 0) {
                    ic.innerHTML = '<div class="date-leaves-title">이 날짜의 연차 현황</div>' + leaves.map(l => { const ts = (l.start_time && l.end_time) ? ' ('+l.start_time.substring(0,5)+'~'+l.end_time.substring(0,5)+')' : ''; return `<div class="date-leave-user"><div class="date-leave-user-dot" style="background:${userColors[l.userId % userColors.length]}"></div><span>${l.userName}</span><span style="color:var(--text-secondary);margin-left:auto">${leaveLabels[l.type] || '반차'}${ts}</span></div>`; }).join('');
                    ic.style.display = 'block';
                } else ic.style.display = 'none';
            }
            document.querySelectorAll('.leave-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('leaveModal').classList.add('active');
        }
        function closeLeaveModal() { document.getElementById('leaveModal').classList.remove('active'); state.selectedDates = []; state.selectedType = null; document.getElementById('timePickerArea').classList.remove('show'); renderCalendar(); }
        function selectLeaveType(t) { state.selectedType = t; document.querySelectorAll('.leave-option').forEach(o => o.classList.remove('selected')); document.querySelector(`.leave-option[data-type="${t}"]`).classList.add('selected'); showTimePicker(t); }
        function confirmLeave() {
            if (!state.selectedDates || state.selectedDates.length === 0 || !state.selectedType) { showToast('연차 유형을 선택해주세요.', 'error'); return; }
            const selType = state.selectedType;
            const isTimeBased = (selType === 'half' || selType === 'quarter');

            // 시간 기반 유형: 시간 유효성 검사
            let startTime = '', endTime = '', hours = 0;
            if (isTimeBased) {
                startTime = document.getElementById('leaveStartTime').value;
                endTime = document.getElementById('leaveEndTime').value;
                if (!startTime || !endTime) { showToast('시간을 선택해주세요.', 'error'); return; }
                const sh = parseInt(startTime), sm = parseInt(startTime.substring(3));
                const eh = parseInt(endTime), em = parseInt(endTime.substring(3));
                const diffMin = (eh * 60 + em) - (sh * 60 + sm);
                if (diffMin <= 0) { showToast('종료시간은 시작시간보다 이후여야 합니다.', 'error'); return; }
                hours = diffMin / 60;
            }

            const u = getCurrentUser(), totalDays = state.selectedDates.length * leaveDeduction[selType];
            if (!u.unlimited) {
                const t = getTotalLeave(u), will = calculateUsed(u) + calculatePending(u) + totalDays;
                if (will > t) { showToast('잔여 연차가 부족합니다!', 'error'); return; }
            }

            // 저장할 type 결정 (반차는 시간에 따라 half-am/half-pm으로 구분)
            let saveType = selType;
            if (selType === 'half') {
                const sh = parseInt(startTime);
                const eh = parseInt(endTime);
                const midH = (sh + eh) / 2;
                saveType = midH < 13 ? 'half-am' : 'half-pm';
            }

            state.selectedDates.forEach(ds => {
                const leaveData = { type: saveType, status: 'pending', requestDate: new Date().toISOString() };
                if (isTimeBased) {
                    leaveData.start_time = startTime + ':00';
                    leaveData.end_time = endTime + ':00';
                    leaveData.hours = hours;
                }
                u.leaves[ds] = leaveData;
            });
            const timeLabel = isTimeBased ? ` (${startTime}~${endTime})` : '';
            const msg = state.selectedDates.length > 1 ? `${state.selectedDates.length}일 ${leaveLabels[saveType]} 신청 완료${timeLabel}` : `${leaveLabels[saveType]} 신청 완료${timeLabel}`;
            showToast(`${msg}. 관리자 승인을 기다려주세요.`, 'success');
            closeLeaveModal(); saveState(); updateUI();
        }

        function openAdminModal() { document.getElementById('adminModal').classList.add('active'); document.getElementById('adminPassword').value = ''; document.getElementById('adminLoginForm').style.display = 'block'; document.getElementById('adminContent').style.display = 'none'; }
        function closeAdminModal() { document.getElementById('adminModal').classList.remove('active'); }
        function adminLogin() {
            if (document.getElementById('adminPassword').value === state.adminPassword) {
                document.getElementById('adminLoginForm').style.display = 'none'; document.getElementById('adminContent').style.display = 'block';
                renderPendingList(); renderCancelRequestList(); renderUserManageList(); renderLeaveManageList(); renderCancelHistory(); updatePendingCount(); showToast('관리자 로그인 성공', 'success');
            } else showToast('비밀번호가 틀렸습니다.', 'error');
        }
        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab-content').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.tabs .tab').forEach(e => e.classList.remove('active'));
            document.getElementById(`adminTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
            event.target.classList.add('active');
            if (tab === 'pending') renderPendingList();
            if (tab === 'cancelRequests') renderCancelRequestList();
            if (tab === 'users') renderUserManageList();
            if (tab === 'leaves') renderLeaveManageList();
            if (tab === 'history') renderCancelHistory();
        }
        function updatePendingCount() { 
            const pc = getTotalPendingCount(), cc = getCancelRequestCount(), total = pc + cc;
            document.getElementById('pendingCount').textContent = total > 0 ? `(${total})` : '';
        }

        function renderPendingList() {
            const c = document.getElementById('pendingList'), items = [];
            state.users.forEach(u => Object.entries(u.leaves).forEach(([ds, l]) => { if (l.status === 'pending') items.push({ userId: u.id, userName: u.name, date: ds, type: l.type, start_time: l.start_time||'', end_time: l.end_time||'' }); }));
            if (items.length === 0) { c.innerHTML = '<div class="empty-state"><p>승인 대기 중인 연차가 없습니다.</p></div>'; } else {
                items.sort((a, b) => a.date.localeCompare(b.date));
                c.innerHTML = '<div style="font-weight:600;margin-bottom:10px;color:var(--accent-orange)">📋 승인 대기</div>' + items.map(i => {
                    const [y, m, d] = i.date.split('-'), date = new Date(2026, parseInt(m)-1, parseInt(d)), wd = weekdays[date.getDay()];
                    const ts = (i.start_time && i.end_time) ? ' '+i.start_time.substring(0,5)+'~'+i.end_time.substring(0,5) : '';
                    return `<div class="pending-item"><div style="width:12px;height:12px;border-radius:50%;background:${userColors[i.userId % userColors.length]}"></div><div class="pending-item-info"><div class="pending-item-user">${i.userName}</div><div class="pending-item-date">${parseInt(m)}월 ${parseInt(d)}일 (${wd}) - ${leaveLabels[i.type] || '반차'} (${leaveDeduction[i.type] || 0.5}일)${ts}</div></div><div class="pending-item-actions"><button class="btn btn-success btn-small" onclick="approveLeave(${i.userId},'${i.date}')">승인</button><button class="btn btn-danger btn-small" onclick="rejectLeave(${i.userId},'${i.date}')">반려</button></div></div>`;
                }).join('');
            }
            renderCancelRequestList();
        }
        function approveLeave(uid, ds) { const u = state.users.find(x => x.id === uid); if (u && u.leaves[ds]) { u.leaves[ds].status = 'approved'; saveState(); renderPendingList(); updatePendingCount(); updateUI(); showToast(`${u.name}의 연차가 승인되었습니다.`, 'success'); } }
        function rejectLeave(uid, ds) { const u = state.users.find(x => x.id === uid); if (u && u.leaves[ds] && confirm(`${u.name}의 연차 신청을 반려하시겠습니까?`)) { delete u.leaves[ds]; saveState(); renderPendingList(); updatePendingCount(); updateUI(); showToast(`${u.name}의 연차가 반려되었습니다.`, 'success'); } }

        function renderCancelRequestList() {
            const c = document.getElementById('cancelRequestList'), items = [];
            state.users.forEach(u => Object.entries(u.leaves).forEach(([ds, l]) => { if (l.status === 'cancel-requested') items.push({ userId: u.id, userName: u.name, date: ds, type: l.type, reason: l.cancelReason }); }));
            if (items.length === 0) { c.innerHTML = ''; return; }
            items.sort((a, b) => a.date.localeCompare(b.date));
            c.innerHTML = '<div style="font-weight:600;margin-bottom:10px;color:var(--accent-red)">🔄 취소 요청</div>' + items.map(i => {
                const [y, m, d] = i.date.split('-'), date = new Date(2026, parseInt(m)-1, parseInt(d)), wd = weekdays[date.getDay()];
                return `<div class="pending-item" style="border-left-color:var(--accent-red)"><div style="width:12px;height:12px;border-radius:50%;background:${userColors[i.userId % userColors.length]}"></div><div class="pending-item-info"><div class="pending-item-user">${i.userName}</div><div class="pending-item-date">${parseInt(m)}월 ${parseInt(d)}일 (${wd}) - ${leaveLabels[i.type]}</div><div style="font-size:0.8rem;color:var(--accent-red);margin-top:4px">사유: ${i.reason}</div></div><div class="pending-item-actions"><button class="btn btn-success btn-small" onclick="approveCancelRequest(${i.userId},'${i.date}')">승인</button><button class="btn btn-secondary btn-small" onclick="rejectCancelRequest(${i.userId},'${i.date}')">거부</button></div></div>`;
            }).join('');
        }
        function approveCancelRequest(uid, ds) {
            const u = state.users.find(x => x.id === uid);
            if (u && u.leaves[ds]) {
                state.cancelHistory.push({ userId: uid, userName: u.name, date: ds, type: u.leaves[ds].type, reason: u.leaves[ds].cancelReason, cancelledAt: new Date().toISOString() });
                delete u.leaves[ds];
                saveState(); renderCancelRequestList(); renderCancelHistory(); updatePendingCount(); updateUI();
                showToast(`${u.name}의 연차 취소가 승인되었습니다.`, 'success');
            }
        }
        function rejectCancelRequest(uid, ds) {
            const u = state.users.find(x => x.id === uid);
            if (u && u.leaves[ds] && confirm(`${u.name}의 취소 요청을 거부하시겠습니까?`)) {
                u.leaves[ds].status = 'approved';
                delete u.leaves[ds].cancelReason;
                delete u.leaves[ds].cancelRequestDate;
                saveState(); renderCancelRequestList(); updatePendingCount(); updateUI();
                showToast('취소 요청이 거부되었습니다.', 'success');
            }
        }
        function renderCancelHistory() {
            const c = document.getElementById('cancelHistoryList');
            if (!state.cancelHistory || state.cancelHistory.length === 0) { c.innerHTML = '<div class="empty-state"><p>취소 이력이 없습니다.</p></div>'; return; }
            const sorted = [...state.cancelHistory].sort((a, b) => b.cancelledAt.localeCompare(a.cancelledAt));
            c.innerHTML = sorted.map((h, idx) => {
                const [y, m, d] = h.date.split('-'), cancelDate = new Date(h.cancelledAt).toLocaleDateString('ko-KR');
                const origIdx = state.cancelHistory.findIndex(x => x.cancelledAt === h.cancelledAt && x.userId === h.userId && x.date === h.date);
                return `<div style="padding:8px 12px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:6px;border-left:3px solid var(--accent-red);display:flex;align-items:center;justify-content:space-between;font-size:0.85rem"><div style="flex:1;display:flex;flex-wrap:wrap;align-items:center;gap:8px"><span style="font-weight:500">${h.userName}</span><span style="color:var(--text-secondary)">${parseInt(m)}/${parseInt(d)} ${leaveLabels[h.type]}</span><span style="color:var(--accent-red);font-size:0.8rem">사유: ${h.reason}</span><span style="color:var(--text-secondary);font-size:0.75rem">(${cancelDate})</span></div><button class="btn btn-danger" style="padding:3px 8px;font-size:0.7rem" onclick="deleteCancelHistoryItem(${origIdx})">삭제</button></div>`;
            }).join('');
        }
        function deleteCancelHistoryItem(idx) {
            if (confirm('이 취소 이력을 삭제하시겠습니까?')) {
                state.cancelHistory.splice(idx, 1);
                saveState();
                renderCancelHistory();
                showToast('취소 이력이 삭제되었습니다.', 'success');
            }
        }
        function clearCancelHistory() {
            if (confirm('취소 이력을 전체 삭제하시겠습니까?')) {
                state.cancelHistory = [];
                saveState();
                renderCancelHistory();
                showToast('취소 이력이 삭제되었습니다.', 'success');
            }
        }

        function renderUserManageList() {
            document.getElementById('userManageList').innerHTML = state.users.map(u => {
                const bt = getTotalBonus(u), lt = u.unlimited ? '무제한' : (bt > 0 ? `${getTotalLeave(u)}일 (기본 ${u.totalLeave} + 포상 ${bt})` : `${u.totalLeave}일`);
                return `<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-tertiary);border-radius:10px;margin-bottom:8px"><div style="width:12px;height:12px;border-radius:50%;background:${userColors[u.id % userColors.length]}"></div><div style="flex:1"><div style="font-weight:500">${u.name}</div><div style="font-size:0.8rem;color:var(--text-secondary)">연차: ${lt}</div></div><button class="btn btn-danger" style="padding:4px 10px;font-size:0.75rem" onclick="deleteUser(${u.id})">삭제</button></div>`;
            }).join('');
        }

        function renderLeaveManageList() {
            document.getElementById('leaveManageList').innerHTML = state.users.map(u => {
                const used = calculateUsed(u), pend = getPendingCount(u), bt = getTotalBonus(u);
                const info = u.unlimited ? `무제한 | 사용: ${used}일 | 대기: ${pend}건` : `총: ${getTotalLeave(u)}일 (기본 ${u.totalLeave} + 포상 ${bt}) | 사용: ${used}일 | 잔여: ${getTotalLeave(u) - used}일 | 대기: ${pend}건`;
                const entries = Object.entries(u.leaves).sort((a, b) => a[0].localeCompare(b[0]));
                return `<div style="background:var(--bg-tertiary);border-radius:10px;padding:14px;margin-bottom:10px"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px"><div style="width:10px;height:10px;border-radius:50%;background:${userColors[u.id % userColors.length]}"></div><div style="flex:1"><div style="font-weight:500;font-size:0.9rem">${u.name}</div><div style="font-size:0.85rem;color:var(--text-secondary)">${info}</div></div><button class="btn btn-secondary" style="padding:4px 10px;font-size:0.75rem" onclick="openEditLeaveModal(${u.id})">연차 설정</button></div>${entries.length > 0 ? `<div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:6px">신청 내역:</div><div style="display:flex;flex-wrap:wrap;gap:6px">${entries.map(([ds, l]) => { const [y, m, d] = ds.split('-'); const ts = (l.start_time && l.end_time) ? ' '+l.start_time.substring(0,5)+'~'+l.end_time.substring(0,5) : ''; return `<div style="display:flex;align-items:center;gap:5px;background:var(--bg-primary);padding:4px 8px;border-radius:5px;font-size:0.75rem"><span style="font-weight:500">${parseInt(m)}/${parseInt(d)} ${leaveLabels[l.type] || '반차'}${ts}</span><span style="color:${l.status === 'pending' ? 'var(--accent-orange)' : 'var(--accent-green)'};font-size:0.7rem">${l.status === 'pending' ? '대기' : '승인'}</span><button onclick="adminDeleteLeave(${u.id},'${ds}')" style="background:none;border:none;color:var(--accent-red);cursor:pointer;padding:1px;font-size:0.65rem">✕</button></div>`; }).join('')}</div>` : '<div style="font-size:0.75rem;color:var(--text-secondary)">신청 내역 없음</div>'}</div>`;
            }).join('');
        }
        function adminDeleteLeave(uid, ds) { const u = state.users.find(x => x.id === uid); if (u && confirm(`${u.name}의 해당 연차를 삭제하시겠습니까?`)) { delete u.leaves[ds]; saveState(); renderLeaveManageList(); renderPendingList(); updatePendingCount(); updateUI(); showToast('연차가 삭제되었습니다.', 'success'); } }

        function openEditLeaveModal(uid) {
            state.editingUserId = uid; const u = state.users.find(x => x.id === uid);
            document.getElementById('editLeaveTitle').textContent = `${u.name} 연차 수정`;
            document.getElementById('editLeaveValue').value = u.totalLeave;
            document.getElementById('editUnlimited').checked = u.unlimited;
            document.getElementById('newBonusDays').value = 0; document.getElementById('newBonusReason').value = '';
            renderBonusList(); updateEditTotalDisplay();
            document.getElementById('editLeaveModal').classList.add('active');
        }
        function closeEditLeaveModal() { document.getElementById('editLeaveModal').classList.remove('active'); state.editingUserId = null; }
        function renderBonusList() {
            const u = state.users.find(x => x.id === state.editingUserId), c = document.getElementById('bonusList');
            if (!u.bonusLeaves || u.bonusLeaves.length === 0) { c.innerHTML = '<p style="font-size:0.8rem;color:var(--text-secondary);margin-top:12px">포상 연차 내역이 없습니다.</p>'; return; }
            c.innerHTML = '<h4 style="margin:16px 0 8px;font-size:0.85rem">포상 연차 내역</h4>' + u.bonusLeaves.map((b, i) => `<div class="bonus-item"><div class="bonus-item-info"><span class="bonus-item-days">+${b.days}일</span><span class="bonus-item-reason">${b.reason}</span><div class="bonus-item-date">${new Date(b.date).toLocaleDateString('ko-KR')}</div></div><button class="btn btn-danger btn-small" onclick="removeBonusLeave(${i})">삭제</button></div>`).join('');
        }
        function addBonusLeave() {
            const days = parseFloat(document.getElementById('newBonusDays').value) || 0, reason = document.getElementById('newBonusReason').value.trim();
            if (days <= 0) { showToast('포상 일수를 입력해주세요.', 'error'); return; }
            if (!reason) { showToast('포상 사유를 입력해주세요.', 'error'); return; }
            const u = state.users.find(x => x.id === state.editingUserId);
            u.bonusLeaves.push({ days, reason, date: new Date().toISOString() });
            document.getElementById('newBonusDays').value = 0; document.getElementById('newBonusReason').value = '';
            renderBonusList(); updateEditTotalDisplay(); showToast('포상 연차가 추가되었습니다.', 'success');
        }
        function removeBonusLeave(idx) {
            const u = state.users.find(x => x.id === state.editingUserId);
            if (confirm('이 포상 연차를 삭제하시겠습니까?')) { u.bonusLeaves.splice(idx, 1); renderBonusList(); updateEditTotalDisplay(); showToast('포상 연차가 삭제되었습니다.', 'success'); }
        }
        function updateEditTotalDisplay() {
            const u = state.users.find(x => x.id === state.editingUserId), base = parseFloat(document.getElementById('editLeaveValue').value) || 0, bonus = getTotalBonus(u);
            document.getElementById('editTotalDisplay').textContent = (base + bonus) + '일';
        }
        document.getElementById('editLeaveValue').addEventListener('input', updateEditTotalDisplay);

        function saveUserLeave() {
            const val = parseFloat(document.getElementById('editLeaveValue').value) || 0, unlim = document.getElementById('editUnlimited').checked, u = state.users.find(x => x.id === state.editingUserId);
            if (!unlim && val < 0) { showToast('연차는 0 이상이어야 합니다.', 'error'); return; }
            if (!unlim) { const used = calculateUsed(u), nt = val + getTotalBonus(u); if (nt < used) { showToast(`이미 사용된 연차(${used}일)보다 적게 설정할 수 없습니다.`, 'error'); return; } }
            u.totalLeave = val; u.unlimited = unlim;
            closeEditLeaveModal(); saveState(); updateUI(); renderLeaveManageList(); showToast(`${u.name}의 연차 설정이 변경되었습니다.`, 'success');
        }

        function addUser() {
            const name = document.getElementById('newUserName').value.trim(), leave = parseFloat(document.getElementById('newUserLeave').value) || 15, unlim = document.getElementById('newUserUnlimited').checked;
            if (!name) { showToast('이름을 입력해주세요.', 'error'); return; }
            const nid = Math.max(...state.users.map(u => u.id), -1) + 1;
            state.users.push({ id: nid, name, totalLeave: unlim ? 0 : leave, bonusLeaves: [], unlimited: unlim, leaves: {} });
            document.getElementById('newUserName').value = ''; document.getElementById('newUserLeave').value = '15'; document.getElementById('newUserUnlimited').checked = false;
            saveState(); updateUI(); renderUserManageList(); showToast(`${name}이(가) 추가되었습니다.`, 'success');
        }
        function quickJoin() {
            const name = document.getElementById('quickJoinName').value.trim();
            if (!name) { showToast('이름을 입력해주세요.', 'error'); return; }
            // 이미 등록된 이름인지 확인
            const existing = state.users.find(u => u.name === name);
            if (existing) {
                state.currentUserId = existing.id;
                localStorage.setItem('sq_vc_local', JSON.stringify({currentUserId: existing.id}));
                updateUI();
                document.getElementById('quickJoinName').value = '';
                showToast(`${name}님, 환영합니다! 달력에서 날짜를 클릭하여 연차를 신청하세요.`, 'success');
                return;
            }
            const nid = Math.max(...state.users.map(u => u.id), -1) + 1;
            state.users.push({ id: nid, name, totalLeave: 15, bonusLeaves: [], unlimited: false, leaves: {} });
            state.currentUserId = nid;
            document.getElementById('quickJoinName').value = '';
            saveState(); updateUI();
            showToast(`${name}님이 등록되었습니다! 달력에서 날짜를 클릭하여 연차를 신청하세요.`, 'success');
        }
        document.getElementById('quickJoinName').addEventListener('keypress', function(e) { if (e.key === 'Enter') quickJoin(); });

        function deleteUser(uid) {
            if (state.users.length <= 1) { showToast('최소 1명의 팀원이 필요합니다.', 'error'); return; }
            const u = state.users.find(x => x.id === uid);
            if (confirm(`${u.name}을(를) 삭제하시겠습니까?`)) {
                state.users = state.users.filter(x => x.id !== uid);
                if (state.currentUserId === uid) state.currentUserId = state.users[0].id;
                saveState(); updateUI(); renderUserManageList(); showToast(`${u.name}이(가) 삭제되었습니다.`, 'success');
            }
        }
        function changePassword() {
            const np = document.getElementById('newPassword').value;
            if (!np) { showToast('새 비밀번호를 입력해주세요.', 'error'); return; }
            state.adminPassword = np; document.getElementById('newPassword').value = ''; saveState(); showToast('비밀번호가 변경되었습니다.', 'success');
        }

        function openReportModal() { renderReport(); document.getElementById('reportModal').classList.add('active'); }
        function closeReportModal() { document.getElementById('reportModal').classList.remove('active'); }
        function renderReport() {
            let totalAll = 0, usedAll = 0, pendAll = 0;
            state.users.forEach(u => { if (!u.unlimited) { totalAll += getTotalLeave(u); usedAll += calculateUsed(u); pendAll += calculatePending(u); } });
            document.getElementById('reportSummary').innerHTML = `<div class="report-summary-card"><div class="report-summary-value" style="color:var(--accent-blue)">${totalAll}</div><div class="report-summary-label">전체 부여 연차</div></div><div class="report-summary-card"><div class="report-summary-value" style="color:var(--accent-purple)">${usedAll}</div><div class="report-summary-label">전체 사용 연차</div></div><div class="report-summary-card"><div class="report-summary-value" style="color:var(--accent-green)">${totalAll - usedAll - pendAll}</div><div class="report-summary-label">전체 잔여 연차</div></div><div class="report-summary-card"><div class="report-summary-value" style="color:var(--accent-orange)">${pendAll}</div><div class="report-summary-label">승인 대기</div></div>`;
            document.getElementById('reportTableBody').innerHTML = state.users.map(u => {
                const bt = getTotalBonus(u), t = getTotalLeave(u), used = calculateUsed(u), pend = calculatePending(u), rem = u.unlimited ? '-' : (t - used - pend);
                return `<tr><td><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${userColors[u.id % userColors.length]};margin-right:8px"></span>${u.name}</td><td>${u.unlimited ? '-' : u.totalLeave}</td><td>${u.unlimited ? '-' : bt}</td><td>${u.unlimited ? '-' : t}</td><td>${used}</td><td>${rem}</td><td>${getPendingCount(u)}</td></tr>`;
            }).join('');
            document.getElementById('reportDetails').innerHTML = state.users.map(u => {
                const entries = Object.entries(u.leaves).sort((a, b) => a[0].localeCompare(b[0]));
                if (entries.length === 0) return '';
                return `<div style="margin-bottom:20px"><h5 style="margin-bottom:8px;display:flex;align-items:center;gap:8px"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${userColors[u.id % userColors.length]}"></span>${u.name}</h5><div style="display:flex;flex-wrap:wrap;gap:6px">${entries.map(([ds, l]) => { const [y, m, d] = ds.split('-'); return `<div style="background:var(--bg-tertiary);padding:6px 12px;border-radius:6px;font-size:0.85rem">${parseInt(m)}/${parseInt(d)} ${leaveLabels[l.type]} <span style="color:${l.status === 'pending' ? 'var(--accent-orange)' : 'var(--accent-green)'};">${l.status === 'pending' ? '(대기)' : '(승인)'}</span></div>`; }).join('')}</div></div>`;
            }).join('');
        }
        function exportReport() {
            // 시트1: 연차 현황 요약
            const summaryData = [['이름', '기본연차', '포상연차', '총연차', '사용', '잔여', '대기']];
            state.users.forEach(u => {
                const bt = getTotalBonus(u), t = getTotalLeave(u), used = calculateUsed(u), pend = calculatePending(u);
                summaryData.push([
                    u.name,
                    u.unlimited ? '-' : u.totalLeave,
                    u.unlimited ? '-' : bt,
                    u.unlimited ? '-' : t,
                    used,
                    u.unlimited ? '-' : (t - used - pend),
                    getPendingCount(u)
                ]);
            });

            // 시트2: 연차 사용일자 상세
            const detailData = [['이름', '날짜', '연차유형', '시간', '차감일수', '상태']];
            state.users.forEach(u => {
                const entries = Object.entries(u.leaves).sort((a, b) => a[0].localeCompare(b[0]));
                entries.forEach(([ds, l]) => {
                    const [y, m, d] = ds.split('-');
                    const ts = (l.start_time && l.end_time) ? l.start_time.substring(0,5)+'~'+l.end_time.substring(0,5) : '종일';
                    detailData.push([
                        u.name,
                        `${y}년 ${parseInt(m)}월 ${parseInt(d)}일`,
                        leaveLabels[l.type] || '반차',
                        ts,
                        leaveDeduction[l.type] || 0.5,
                        l.status === 'pending' ? '승인대기' : l.status === 'cancel-requested' ? '취소요청' : '승인완료'
                    ]);
                });
            });

            // Excel 워크북 생성
            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            const ws2 = XLSX.utils.aoa_to_sheet(detailData);
            
            // 열 너비 설정
            ws1['!cols'] = [{wch:10},{wch:10},{wch:10},{wch:10},{wch:8},{wch:8},{wch:8}];
            ws2['!cols'] = [{wch:10},{wch:18},{wch:10},{wch:14},{wch:10},{wch:10}];
            
            XLSX.utils.book_append_sheet(wb, ws1, '연차현황');
            XLSX.utils.book_append_sheet(wb, ws2, '사용일자상세');
            
            XLSX.writeFile(wb, '스퀘어건축사사무소_26년_연차_리포트.xlsx');
            showToast('리포트가 다운로드되었습니다.', 'success');
        }

        function showToast(msg, type = 'success') { const t = document.getElementById('toast'); t.textContent = msg; t.className = `toast ${type} show`; setTimeout(() => t.classList.remove('show'), 3000); }
        function updateUI() { renderUserTabs(); renderTeamLegend(); renderCalendar(); updateStats(); renderTeamOverview(); renderSelectedList(); }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeLeaveModal(); closeAdminModal(); closeEditLeaveModal(); closeReportModal(); closeCancelRequestModal(); } });
        document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }));

        // 초기 로딩: Firebase에서 데이터 불러온 후 UI 렌더링 & 실시간 리스너 시작
        loadState().then(() => {
            updateUI();
            startRealtimeSync();
            // 로딩 오버레이 제거
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        });
    </script>
</body>
</html>
